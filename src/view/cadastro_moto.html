<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Motocicleta - Motor Company</title>
    <!-- CSS atualizado para o botão de IA -->
    <link rel="stylesheet" href="../style/cadastro_moto.css">
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <div id="container">
        <div id="login-box">
            <a href="principal.html" class="back-link">&larr; Voltar para a principal</a>
            
            <h1>Cadastrar Motocicleta</h1>
            <p>Preencha os dados da nova motocicleta.</p>

            <!-- O action aponta para o script que SALVA no banco -->
            <form action="../controllers/cadastro_moto.php" method="post">
                <div class="grupo">
                    <label for="nome_empresa">Marca / Empresa</label>
                    <input type="text" id="nome_empresa" name="nome_empresa" placeholder="Ex: Honda, Yamaha" required>
                </div>
                <div class="grupo">
                    <label for="modelo">Modelo</label>
                    <input type="text" id="modelo" name="modelo" placeholder="Ex: CB 1000R, MT-09" required>
                </div>
                <div class="grupo">
                    <label for="valor">Valor (R$)</label>
                    <input type="number" id="valor" name="valor" placeholder="Ex: 50000" step="0.01" min="0" required>
                </div>

                <!-- CAMPO DE DESCRIÇÃO DA IA -->
                <div class="grupo">
                    <label for="descricao">Descrição</label>
                    <textarea id="descricao" name="descricao" rows="6" placeholder="Clique no botão abaixo para gerar a descrição..."></textarea>
                    
                    <!-- Botão para acionar a IA (PHP) -->
                    <button type="button" id="btn-gerar-ia" class="btn-ia">
                        <span id="ia-text">Gerar Descrição com IA</span>
                        <span id="ia-loader" class="loader" style="display:none;"></span>
                    </button>
                </div>
                
                <button type="submit">Cadastrar Moto</button>
            </form>
        </div>
    </div>

    <!-- SCRIPT PARA CHAMAR O BACKEND PHP (COM DEBUG) -->
    <script>
        // Checkpoint 1: O script está sendo executado?
        console.log('Script de IA iniciado.');

        // Espera o DOM carregar (boa prática)
        document.addEventListener('DOMContentLoaded', () => {
            
            // Checkpoint 2: O DOM carregou.
            console.log('DOM carregado. Procurando o botão...');

            const btnGerarIa = document.getElementById('btn-gerar-ia');

            // Checkpoint 3: O botão foi encontrado?
            console.log('Botão "Gerar com IA" encontrado:', btnGerarIa);

            if (btnGerarIa) {
                btnGerarIa.addEventListener('click', () => {
                    
                    // Checkpoint 4: O botão foi CLICADO!
                    console.log('Botão de IA clicado!');

                    const phpApiUrl = '../controllers/gerador_descricao.php';
                    const marca = document.getElementById('nome_empresa').value;
                    const modelo = document.getElementById('modelo').value;
                    const descricaoTextarea = document.getElementById('descricao');
                    const btnText = document.getElementById('ia-text');
                    const btnLoader = document.getElementById('ia-loader');

                    if (!marca || !modelo) {
                        alert('Por favor, preencha a Marca e o Modelo antes de gerar a descrição.');
                        return;
                    }

                    // Checkpoint 5: Enviando dados para o PHP...
                    console.log('Enviando dados para o PHP:', { marca, modelo });

                    btnText.style.display = 'none';
                    btnLoader.style.display = 'block';
                    descricaoTextarea.value = "Gerando descrição, aguarde...";

                    fetch(phpApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            marca: marca,
                            modelo: modelo
                        })
                    })
                    .then(response => {
                        // Checkpoint 6: O PHP respondeu!
                        console.log('Resposta do PHP recebida:', response);
                        if (!response.ok) {
                            throw new Error('Erro na resposta do servidor PHP (ver aba Network para detalhes)');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Checkpoint 7: Resposta JSON processada.
                        console.log('Dados JSON recebidos:', data);
                        
                        if (data.descricao) {
                            descricaoTextarea.value = data.descricao;
                        } else if (data.erro) {
                            throw new Error(data.erro);
                        } else {
                            throw new Error('Resposta do PHP não continha a "descricao".');
                        }
                    })
                    .catch(error => {
                        // Checkpoint 8: Ocorreu um ERRO.
                        console.error('Erro no processo de fetch:', error);
                        descricaoTextarea.value = `Falha ao gerar a descrição: ${error.message}. Verifique o console.`;
                    })
                    .finally(() => {
                        // Checkpoint 9: Finalizando (limpando o loading).
                        console.log('Processo finalizado.');
                        btnText.style.display = 'inline';
                        btnLoader.style.display = 'none';
                    });
                });
                
                // Checkpoint 3.1: O "ouvinte" foi adicionado.
                console.log('Ouvinte de clique adicionado ao botão.');
            } else {
                console.error('ERRO CRÍTICO: Não foi possível encontrar o botão com ID "btn-gerar-ia".');
            }
        });
    </script>
</body>
</html>